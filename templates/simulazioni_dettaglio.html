<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Dettaglio Simulazione</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/main.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .container-simulazione {
            display: flex;
            flex-direction: row;
            gap: 30px;
        }
        .col-mappa {
            flex: 1;
            min-width: 400px;
        }
        .col-liste {
            flex: 1;
            min-width: 300px;
        }
        #mapid {
            height: 500px;
            width: 100%;
            margin-bottom: 20px;
        }
        ul {
            margin-bottom: 30px;
        }

        .banner {
            background: #e3e3e3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body class="is-preload">

		<!-- Header -->
			<header id="header">
				<div class="inner">
					<a href="{{ url_for('mappa_page') }}" class="image dozza"><img src="{{ url_for('static', filename='images/thumbs/dozza.jpg') }}" width="100%" alt="" /></a>
					<h1 style="font-size: 3em"><strong>Dozza Turism</strong></h1>
					<p>Applicazione gestita dall'amministrazione pubblica del Comune di Dozza, orientata all'ottimizzazione e gestione dei flussi turistici. </p>
				</div>
			</header>

		<!-- Main -->
			<div id="main">

				<!-- One -->
					<section class="intro">
                        <div class="banner">
                            <strong>Data simulazione:</strong> {{ simulazione.data }} &nbsp; | &nbsp;
                            <strong>Turisti previsti:</strong> {{ simulazione.n_turisti }}
                        </div>

                        <div class="container-simulazione">
                            <!-- Colonna mappa -->
                            <div class="col-mappa">
                                <div id="mapid"></div>
                            </div>
                            <!-- Colonna liste -->
                            <div class="col-liste">
                                <h3>Parcheggi da Aprire</h3>
                                <ul>
                                    {% for p in simulazione.parcheggi %}
                                        <li>{{ p.nome }} ({{ p.comune }})</li>
                                    {% endfor %}
                                </ul>

                                <h3>Linee utilizzate</h3>
                                <ul>
                                    {% for l in simulazione.linee %}
                                        <li>{{ l.nome_linea or l.nome }}<br>
                                            Da: {{ l.comune_partenza }} → {{ l.comune_arrivo }}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div style="text-align:center; margin: 30px 0;">
                            <a href="#" style="margin-top: 10px; align-items: center;" class="button" onclick="esportaSimulazione(); return false;">Esporta dati simulazione</a>
                        </div>

                        <div style="text-align:center; margin-bottom: 30px;">
                            <a href="{{ url_for('simulazioni') }}" class="button">Torna all'elenco simulazioni</a>
                            <a href="{{ url_for('mappa_page') }}" class="button">Torna alla mappa</a>
                        </div>
                    </section>

                <!-- Two -->
					<section id="two">
                        <!-- Parcheggi esclusi -->
                        <h3>Parcheggi esclusi dalla simulazione</h3>
                        <table border="1" style="margin-bottom: 20px;">
                            <tr>
                                <th>Nome</th>
                                <th>Comune</th>
                                <th>Capienza</th>
                            </tr>
                            {% for p in simulazione.parcheggi_esclusi %}
                            <tr>
                                <td>{{ p.nome }}</td>
                                <td>{{ p.comune }}</td>
                                <td>{{ p.capienza }}</td>
                            </tr>
                            {% endfor %}
                            {% if simulazione.parcheggi_esclusi|length == 0 %}
                            <tr><td colspan="3" style="text-align:center;">Nessun parcheggio escluso</td></tr>
                            {% endif %}
                        </table>

                        <!-- Linee escluse -->
                        <h3>Linee di trasporto escluse dalla simulazione</h3>
                        <table border="1">
                            <tr>
                                <th>Nome linea</th>
                                <th>P. partenza</th>
                                <th>P. arrivo</th>
                                <th>Capienza</th>
                            </tr>
                            {% for l in simulazione.linee_escluse %}
                            <tr>
                                <td>{{ l.nome_linea or l.nome }}</td>
                                <td>{{ l.partenza_comune }}</td>
                                <td>{{ l.arrivo_comune }}</td>
                                <td>{{ l.capienza }}</td>
                            </tr>
                            {% endfor %}
                            {% if simulazione.linee_escluse|length == 0 %}
                            <tr><td colspan="4" style="text-align:center;">Nessuna linea esclusa</td></tr>
                            {% endif %}
                        </table>
                    </section>

    <!-- JSON safe rendering -->
    <script type="application/json" id="parcheggi-data">{{ simulazione.parcheggi|tojson }}</script>
    <script type="application/json" id="linee-data">{{ simulazione.linee|tojson }}</script>
    <script type="application/json" id="simulazione-data">
        {{ {
            "id": simulazione.id,
            "n_turisti": simulazione.n_turisti,
            "data": simulazione.data,
            "parcheggi_aperti": simulazione.parcheggi or [],
            "linee_utilizzate": simulazione.linee or [],
            "parcheggi_esclusi": simulazione.parcheggi_esclusi or [],
            "linee_escluse": simulazione.linee_escluse or []
        } | tojson }}
</script>
    <script>
const parcheggi = JSON.parse(document.getElementById("parcheggi-data").textContent);
const linee = JSON.parse(document.getElementById("linee-data").textContent);

function parseCoord(val) {
    return parseFloat(String(val).replace(',', '.'));
}

var map = L.map('mapid').setView([44.3511, 11.6519], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Marker parcheggi aperti
parcheggi.forEach(function(p) {
    L.marker([parseCoord(p.latitudine), parseCoord(p.longitudine)], {icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32,32]})})
        .addTo(map)
        .bindPopup(p.nome + " (" + (p.comune || '') + ")");
});

// Linee utilizzate
parcheggi.forEach(function(p) {
    if (p.linee_usate && p.linee_usate.length > 0) {
        p.linee_usate.forEach(function(lu) {
            const l = linee.find(linea => linea.id === lu.linea_id);
            if (l) {
                const partenza = [parseCoord(l.partenza_lat), parseCoord(l.partenza_lng)];
                const arrivo = [parseCoord(l.arrivo_lat), parseCoord(l.arrivo_lng)];
                L.polyline([partenza, arrivo], { color: 'blue', weight: 3 })
                    .addTo(map)
                    .bindPopup(`<strong>Linea ${l.nome_linea || l.nome}</strong><br/>Da: ${l.partenza_comune || ''} a ${l.arrivo_comune || ''}<br/>Turisti: ${lu.turisti}`);
            }
        });
    }
});

        function esportaSimulazione() {
            const simData = JSON.parse(document.getElementById('simulazione-data').textContent);
            const simId = simData.id;

            fetch('/simulazioni/esporta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: simId })
            })
            .then(response => {
                if (!response.ok) throw new Error("Errore durante l'esportazione");
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `simulazione_${simId}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(err => {
                console.error("Errore esportazione:", err);
                alert("❌ Errore durante l'esportazione della simulazione.");
            });
        }

    </script>


</body>
</html>
